# v0.4.3 Release Summary - Warp Parity Phase 1

## 🎯 Overview
**Release Date**: October 4, 2025  
**Version**: 0.4.3  
**Focus**: Warp compatibility (Phase 1: Prepare/Pre-population) + UX improvements

## ✨ Major Features

### 1. Prepare/Pre-population Step
Enable Warp-style "prepare then measure" workflows:

```yaml
prepare:
  ensure_objects:
    - base_uri: "s3://bucket/test/"
      count: 50000           # Create 50K objects
      min_size: 1048576      # 1 MiB minimum
      max_size: 1048576      # 1 MiB maximum
      fill: zero             # Fill pattern (zero or random)
  cleanup: false             # Keep objects after test
```

**Key Benefits**:
- Idempotent: Skips creation if objects already exist
- Fast: 500+ objects/sec on local storage
- Smart cleanup: Only removes objects created by prepare, not workload
- Progress tracking: Real-time ops/sec during preparation

### 2. New CLI Flags

```bash
# Prepare objects once, run tests multiple times
io-bench run --config mixed.yaml --prepare-only
io-bench run --config mixed.yaml
io-bench run --config mixed.yaml

# Override cleanup setting
io-bench run --config mixed.yaml --no-cleanup
```

### 3. Default Concurrency Update
Changed from **16 → 20** to match MinIO Warp's default for better comparability.

## 🐛 Bug Fixes & Improvements

### Progress Bar Consistency
**Before**:
- Prepare: `[████████] 1000/1000` ✅ Nice blocks
- Test: `[###>---] 10/10s` ❌ Ugly characters
- Cleanup: `[████████] 100/100` ✅ Nice blocks

**After**:
- Prepare: `[████████] 1000/1000` ✅
- Test: `[████████] 10/10s` ✅ **FIXED**
- Cleanup: `[████████] 100/100` ✅

### s3dlio Native Methods
**Before**: STAT operations used `get()` as a workaround to measure object size
```rust
// Old inefficient approach
let bytes = store.get(uri).await?;
let size = bytes.len() as u64;
```

**After**: Use s3dlio's native `stat()` method (v0.8.8+)
```rust
// New proper approach
let metadata = store.stat(uri).await?;
let size = metadata.size;
```

**Benefits**:
- ✅ More efficient (no data transfer)
- ✅ Correct semantics (HEAD vs GET)
- ✅ Faster execution
- ✅ Lower bandwidth usage

### Pattern Matching Clarification
Added comprehensive documentation explaining:
- s3dlio's ObjectStore doesn't provide native glob support
- io-bench implements list-and-filter at application level
- This is correct: S3, Azure, GCS don't have native glob
- For local files, s3dlio has `generic_upload_files()` with glob crate

## 📊 Testing Results

### Performance Validation
```bash
# Prepare: 519 objects/sec (1 MiB each)
./io-bench run --config warp_parity_mixed.yaml --prepare-only
  [00:00:01] [████████] 1000/1000 objects (519.9374/s)

# Test: 2,672 ops/s total throughput
./io-bench run --config warp_parity_mixed.yaml
  Wall time: 10.04s
  Total ops: 26823
  Throughput: 2672.07 ops/s
```

### Feature Testing
- ✅ Prepare-only mode: Creates objects and exits
- ✅ Idempotency: Repeated prepare skips existing objects
- ✅ Cleanup: Removes only prepared-*.dat files
- ✅ No-cleanup flag: Overrides config setting
- ✅ Progress bars: Unified visual style across all phases
- ✅ STAT operations: Using native s3dlio method

## 🔧 Technical Changes

### Files Modified
1. **Cargo.toml**: Version bump to 0.4.3
2. **src/config.rs**: Added `PrepareConfig`, `EnsureSpec`, `FillPattern`
3. **src/workload.rs**: 
   - New: `prepare_objects()`, `cleanup_prepared_objects()`
   - Improved: `stat_object_multi_backend()` uses native `stat()`
   - Fixed: Progress bar style consistency
   - Documented: Pattern matching approach
4. **src/main.rs**: Updated `run_workload()` for three-phase execution
5. **.github/copilot-instructions.md**: Updated version to v0.4.3-dev
6. **docs/CHANGELOG.md**: Comprehensive v0.4.3 entry

### Example Configurations
- `tests/configs/warp_parity_mixed.yaml`: Full Warp-style mixed workload
- `tests/configs/warp_cleanup_test.yaml`: Cleanup validation config

## 🎓 s3dlio Integration Verification

### Confirmed Using s3dlio's Native APIs
✅ **Op-log generation**: `s3dlio::init_op_logger()` / `finalize_op_logger()`  
✅ **Op-log reading**: `s3dlio_oplog::OpLogStreamReader` (constant ~1.5 MB memory)  
✅ **Object operations**: `store_for_uri()` / `store_for_uri_with_logger()`  
✅ **STAT operations**: `ObjectStore::stat()` method (v0.8.8+)  

### Pattern Matching Approach
- s3dlio's `ObjectStore::list()` returns all objects in a prefix
- io-bench applies glob filtering at application level
- This is architecturally correct for object storage APIs
- Documented with clear comments in code

## 🚀 Next Steps (v0.5.0)

### Phase 2: Advanced Replay Remapping
- 1→N fanout (round-robin, random, sticky-key strategies)
- N→1 consolidation
- N↔N regex-based remapping
- Rule-based YAML configuration

### Planned Timeline
- **v0.5.0**: Phase 2 - Advanced remapping (2 weeks)
- **v0.5.1**: Phase 3 - UX polish + docs (1 week)
- **v0.5.2**: Phase 4 - Testing + validation (1 week)

## 📝 Usage Examples

### Basic Prepare Workflow
```bash
# 1. Create test YAML
cat > test.yaml <<EOF
duration: 60s
concurrency: 20
prepare:
  ensure_objects:
    - base_uri: "s3://bench/test/"
      count: 10000
      min_size: 1048576
  cleanup: false
workload:
  - {weight: 60, op: get, path: "test/*"}
  - {weight: 30, op: put, path: "test/*", object_size: 1048576}
  - {weight: 10, op: list, path: "test/"}
EOF

# 2. Prepare objects once
io-bench run --config test.yaml --prepare-only

# 3. Run tests multiple times (objects already exist)
io-bench run --config test.yaml
io-bench run --config test.yaml
io-bench run --config test.yaml

# 4. Final run with cleanup
io-bench run --config test.yaml
```

### Warp Parity Example
```yaml
# This config produces nearly identical tests to MinIO Warp
duration: 300s      # 5 minutes (Warp default)
concurrency: 20     # Match Warp

prepare:
  ensure_objects:
    - base_uri: "s3://benchmark/mixed/"
      count: 50000
      min_size: 1048576
  cleanup: false

target: "s3://benchmark/"
workload:
  - {weight: 50, op: get, path: "mixed/*"}
  - {weight: 30, op: put, path: "mixed/*", object_size: 1048576}
  - {weight: 10, op: list, path: "mixed/"}
```

## 🎉 Summary

v0.4.3 delivers the first phase of Warp parity, enabling prepare/pre-population workflows while also improving UX consistency and leveraging s3dlio's native APIs more effectively. The foundation is now in place for advanced replay remapping in v0.5.0.

**Key Achievement**: io-bench can now run nearly identical mixed workload tests to MinIO Warp, with the added benefit of supporting 5 storage backends instead of just S3.
